<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset='utf-8' />
  <!-- 화면 해상도에 따라 글자 크기 대응(모바일 대응) -->
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <!-- jquery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- fullcalendar CDN -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
  <!-- fullcalendar 언어 CDN -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* body 스타일 */
    html, body {
      overflow: hidden;
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      font-size: 14px;
    }
    /* 캘린더 위의 해더 스타일(날짜가 있는 부분) */
    .fc-header-toolbar {
      padding-top: 1em;
      padding-left: 1em;
      padding-right: 1em;
    }
    .modal{
      position:absolute;
      display:none;
      justify-content: center;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background-color: rgba(0,0,0,0.4);
      z-index: 999
    }
    .modal_body{
      position:absolute;
      top:50%;
      width:400px;
      height:600px;
      padding:40px;
      text-align: center;
      background-color: rgb(255,255,255);
      border-radius:10px;
      box-shadow:0 2px 3px 0 rgba(34,36,38,0.15);
      transform:translateY(-50%);
    }
    .modal.active {
      display: flex;
    }
  </style>
</head>
<body style="padding:30px;">
<div class="modal">
  <div class="modal_body">
    <button class="close_btn">닫기</button>
    <form id="addEventForm">
      <label for="content">Content:</label>
      <input type="text" id="content" name="content" required><br><br>

      <label for="eventColor">Event Color:</label>
      <input type="text" id="eventColor" name="eventColor" required><br><br>

      <label for="startDate">Start Date:</label>
      <input type="datetime-local" id="startDate" name="startDate" required><br><br>

      <label for="endDate">End Date:</label>
      <input type="datetime-local" id="endDate" name="endDate" required><br><br>

      <label for="cycle">Cycle:</label>
      <input type="number" id="cycle" name="cycle" required><br><br>

      <button type="submit">Add Event</button>
    </form>

    <!-- 이벤트 수정 폼 -->
    <form id="updateEventForm">
      <label for="eventId">Event ID:</label>
      <input type="number" id="eventId" name="eventId" required><br><br>

      <label for="updateContent">New Content:</label>
      <input type="text" id="updateContent" name="updateContent" required><br><br>

      <label for="updateEventColor">New Event Color:</label>
      <input type="text" id="updateEventColor" name="updateEventColor" ><br><br>

      <label for="updateStartDate">New Start Date:</label>
      <input type="datetime-local" id="updateStartDate" name="updateStartDate" required><br><br>

      <label for="updateEndDate">New End Date:</label>
      <input type="datetime-local" id="updateEndDate" name="updateEndDate" required><br><br>

      <label for="updateCycle">New Cycle:</label>
      <input type="number" id="updateCycle" name="updateCycle" required><br><br>

      <button type="submit">Update Event</button>
    </form>

    <!-- 이벤트 삭제 폼 -->
    <form id="deleteEventForm">
      <label for="deleteEventId">Event ID:</label>
      <input type="number" id="deleteEventId" name="deleteEventId" required><br><br>

      <button type="submit">Delete Event</button>
    </form>
  </div>
</div>

<!-- calendar 태그 -->
<div id='calendar-container'>
  <div id='calendar'></div>
</div>

<!-- 메모 모달 -->
<div class="modal memo-modal">
  <div class="modal_body">
    <button class="close_btn">닫기</button>
    <form id="addMemoForm">
      <label for="memoContent">메모 내용:</label>
      <textarea id="memoContent" name="memoContent" required></textarea><br><br>
      <button type="submit">메모 추가</button>
    </form>
  </div>
</div>


<script>
  $('.modal .close_btn').click(function(){
    $('.modal').css('display', 'none'); // 모달 활성화 클래스 제거
  });

  // 전역 변수로 calendar 선언
  var calendar;

  document.addEventListener('DOMContentLoaded', function () {
    $(function(){
      // 서버에서 이벤트 데이터를 가져오는 함수
      axios.get('/events/all')
              .then(function (response) {

                var data = response.data;
                console.log(data)
                // calendar element 취득
                var calendarEl = document.getElementById('calendar');
                // full-calendar 생성하기
                calendar = new FullCalendar.Calendar(calendarEl, {
                  height: '700px', // calendar 높이 설정
                  expandRows: true, // 화면에 맞게 높이 재설정
                  slotMinTime: '08:00', // Day 캘린더에서 시작 시간
                  slotMaxTime: '20:00', // Day 캘린더에서 종료 시간
                  customButtons: {
                    myCustomButton: {
                      text: "일정 추가하기",
                      click : function (){
                        const modal = document.querySelector('.modal');
                        modal.style.display="flex";
                      }
                    },
                    myMemoButton: { // 메모 버튼 추가
                      text: "메모 추가하기",
                      click : function (){
                        const modal = document.querySelector('.modal.memo-modal');
                        modal.style.display="flex";
                      }
                    },
                    mySaveButton: {
                      text: "저장하기"
                    }
                  },
                  // 해더에 표시할 툴바
                  headerToolbar: {
                    left: 'prev,next today,myCustomButton,myMemoButton,mySaveButton', // 메모 버튼 추가
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                  },

                  initialView: 'dayGridMonth', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
                  editable: true,
                  dayMaxEvents: true, // 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)


                  locale: 'ko',
                  select: function(arg) { // 캘린더에서 드래그로 이벤트를 생성할 수 있다.
                    const modal = document.querySelector('.modal');
                    modal.style.display="flex";

                    // 선택한 날짜 정보를 모달 폼에 전달
                    document.getElementById('startDate').value = arg.startStr;
                    document.getElementById('endDate').value = arg.endStr;
                  }
                });

                // 데이터를 기반으로 이벤트 추가
                data.forEach(function(event) {
                  calendar.addEvent({
                    title: event.content,
                    start: event.startDate,
                    end: event.endDate,
                    backgroundColor: event.eventColor
                    // 다른 필드들도 필요에 따라 추가 가능
                  });
                });

                // 캘린더 랜더링
                calendar.render();
              })
              .catch(function (error) {
                console.log(error);
                alert( "Request failed: " + error.message );
              });
    });
  });


  // 이벤트 추가 폼 이벤트 핸들러
  document.getElementById('addEventForm').addEventListener('submit', function(event) {
    event.preventDefault(); // 페이지 새로고침 방지

    const formData = new FormData(this);
    const eventData = {
      content: formData.get('content'),
      eventColor: formData.get('eventColor'),
      startDate: formData.get('startDate'), // 사용자가 선택한 시작일
      endDate: formData.get('endDate'), // 사용자가 선택한 종료일
      cycle: formData.get('cycle')
    };

    axios.post('http://localhost:12000/add', eventData)
            .then(response => {
              console.log('Event added:', response.data);
              // 캘린더에 이벤트 추가
              calendar.addEvent({
                title: eventData.content,
                start: eventData.startDate,
                end: eventData.endDate,
                backgroundColor: eventData.eventColor
                // 다른 필드들도 필요에 따라 추가 가능
              });
            })
            .catch(error => {
              console.error('Error adding event', error);
            });
  });


  // 메모 추가 폼 이벤트 핸들러
  document.getElementById('addMemoForm').addEventListener('submit', function(event) {
    event.preventDefault(); // 페이지 새로고침 방지

    const formData = new FormData(this);
    const memoData = {
      memoContent: formData.get('memoContent')
    };

    // 여기서 메모를 처리하는 코드를 추가하세요.

    // 모달 닫기
    $('.modal.memo-modal').css('display', 'none');
  });

  // 이벤트 수정 폼 이벤트 핸들러
  document.getElementById('updateEventForm').addEventListener('submit', function(event) {
    event.preventDefault(); // 페이지 새로고침 방지

    const formData = new FormData(this);
    const eventId = formData.get('eventId');
    const updateEventData = {
      content: formData.get('updateContent'),
      eventColor: formData.get('updateEventColor'),
      startDate: formData.get('updateStartDate'),
      endDate: formData.get('updateEndDate'),
      cycle: formData.get('updateCycle')
    };

    axios.post(`/update/${eventId}`, updateEventData)
            .then(response => {
              console.log('Event updated:', response.data);
              // 추가 작업 수행 (예: 화면 갱신)
              // 여기에 화면 갱신 코드 추가
            })
            .catch(error => {
              console.error('Error updating event', error);
            });
  });

  // 이벤트 삭제 폼 이벤트 핸들러
  document.getElementById('deleteEventForm').addEventListener('submit', function(event) {
    event.preventDefault(); // 페이지 새로고침 방지

    const formData = new FormData(this);
    const eventId = formData.get('deleteEventId');

    axios.post(`http://localhost:12000/delete/${eventId}`)
            .then(response => {
              console.log('Event deleted:', response.data);
              // 추가 작업 수행 (예: 화면 갱신)
              // 여기에 화면 갱신 코드 추가
            })
            .catch(error => {
              console.error('Error deleting event', error);
            });

  });
</script>
</body>
</html>
